\section{Mid-ranging control concept}
\label{sec:control}
In this section we present a mid-ranging controller concept which utilizes both CoG positioning and rotors' variations to control vehicle's attitude. We propose to use a structure based on the Valve Position Control (VPC) concept \cite{Allison2003MidRanging}. The concept is named after a liquid flow control problem with a small and a big valve, where a big valve can produce higher flow than a small valve, but with less precision and slower response \cite{Allison1997MidRanging}. On the other hand, using only a small valve often results in actuator saturation and inability to satisfy flow capacities. VPC based control algorithm manipulates both valves to track desired flow level while keaping steady state value of the small valve at given setpoint.

For the MORUS UAS roll/pitch control concept, moving masses are considered as a small valve, while the rotors represent the big valve. We have shown in \cite{Haus2017} that the MMC based control has higher bandwidth than the control based on rotors powered by IC engines. We also claim that rolling/pitching torques can be controlled with higher precision through MMC than with rotors' variations, since the MMC concept idealy controls the position of the CoG in a millimeter range. On the other hand, the torque that can be produced by rotors' variations is much larger than the maximum torque produced by shifting the CoG, which allows us to utilize it as the "big" valve. In the provided experimental results however, we use rotors powered by DC motors to emulate slow rotors and verify the proposed VPC concept. 

In the proposed concept (Fig. \ref{fig:mmc_vpc_structure}), the main controller (MMC) manipulates the position of the moving masses in order to track roll/pitch references. In this paper we utilize a cascade P-P MMC controller whose design, based on root-locus analysis, is presented in \cite{Haus2017}. Note that for the main controller we can utilize any type of MMC controller, e.g. state space controller presented in \cite{Morus2017Icuas}. The auxiliary controller (VPC) generates references for rotors' variations with a goal to keep the steady state position of the moving mass mechanism in the middle of its operating range. Note that the reference for this controller is 0, which is considered as a neutral position in this paper. The feedback signal of the VPC controller is the reference position of the vehicle's CoG  generated by the MMC controller. 

In this paper we show important properties of the MMC-VPC controller for the linearized pitch dynamical model presented by transfer functions $G_1$ and $G_2$. These transfer functions present dynamical effect of the CoG variations and rotors variations to vehicle's pitch angle. If we denote by $C_1$ the main MMC controller and by $C_2$ the auxilliary VPC controller, the closed loop transfer function of the vehicle's pitch angle is given by:
\begin{equation}
 G_{\theta,\theta_r}(s) = \frac{\theta(s)}{\theta_r(s)} = \frac{C_1(G_1 - C_2 G_2)}{1 + C_1(G_1 - C_2 G_2)}.
\label{equ:vpc_tf_y}
\end{equation}
First, we compute the static gain of \eqref{equ:vpc_tf_y} to show that the MMC-VPC controller ensures zero static error given a reference:
\begin{equation}
\lim_{s->0} G_{\theta,\theta_r}(s) = \lim_{s->0} \frac{C_1}{\frac{1}{(G_1 - C_2 G_2)} + C_1} = 1,
\label{equ:vpc_tf_y_gain}
\end{equation}
where we used $\lim_{s->0} (G_1 - C_2 G_2) = \infty$, as the transfer functions $G_1$ and $G_2$ have infinite gain and $C_2$ is chosen as a negative I controller. As both $G_1$ and $G_2$ have positive gains, the gain of $C_2$ is chosen negative to ensure that the moments produced by CoG variations and rotors' variations have the same direction.
Next, we compute closed loop transfer function of $x_{c,ref}(s)$ given an output reference $\theta_r(s)$ and its static gain:
\begin{align}
 G_{x_c,\theta_r}(s) = \frac{x_{c,ref}(s)}{\theta_r(s)} &= \frac{C_1}{1 + C_1(G_1 - C_2 G_2)} \nonumber \\
                                                           &= C_1 (1 - G_{\theta,\theta_r}(s)) \label{equ:vpc_tf_u_yr},\\
\lim_{s->0} G_{x_c,\theta_r}(s) &= 0\label{equ:vpc_tf_u_yr_gain}.
\end{align}
Finally, we compute the transfer functions and static gains of the output value  $\theta$ and CoG position referenxe $x_{c,ref}$ given an output disturbance $d$:
\begin{align}
 G_{\theta,d}(s) = \frac{\theta(s)}{d(s)} &= \frac{1}{1 + C_1(G_1 - C_2 G_2)} \nonumber \\
  										 &= (1 - G_{\theta,\theta_r}(s)), \label{equ:vpc_tf_y_d}\\
\lim_{s->0} G_{\theta,d}(s) &=  0, \label{equ:vpc_tf_y_d_gain} \\
 G_{x_{c,ref},d}(s) = \frac{x_{c,ref}(s)}{d(s)} &= \frac{C_1}{1 + C_1(G_1 - C_2 G_2)} \nonumber \\ 
 											&= C_1 (1 - G_{\theta,\theta_r}(s)), \label{equ:vpc_tf_u_d}\\
\lim_{s->0} G_{x_c,\theta_r}(s) &=  0. \label{equ:vpc_tf_u_d_gain}
\end{align}
The computed steady state gains prove that the proposed MMC-VPC structure ensures reference tracking and output disturbance rejection with zero steady CoG position, which allows the moving mass mechanism to work around the center point of this operating range. %The final property that needs to be considered is system stability. It can be analyzed using Routh-Hurwitz stability criterion with the parameters of each vehicle configuration considered. Using second order model of the moving mass mechanism dynamics and first order model od the rotor dynamics \cite{Haus2017}, we obtain the characteristic polynomial of order 8. The criterion gives us gains limit of the integral controller as a function of the chosen gains of the main controller. For brevity we omit this function here.  

To tune the controller gains we propose a two stage procedure. First, the gains of the cascade P-P controller are chosen according to \cite{Haus2017}, assuming that the output of the auxiliary controller is 0. Second, respecting gain limits from the Routh-Hurwitz analysis, the integral gain of the auxiliary controller is tuned to obtain desired, stable closed loop dynamics.