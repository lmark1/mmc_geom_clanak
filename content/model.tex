\section{Mathematical model}

First of all, it is necessary to introduce a fixed inertial reference frame $\{ \vec{e}_1, \vec{e}_2, \vec{e}_3  \}$ and a body-fixed frame $ \{ \vec{b}_1, \vec{b}_2, \vec{b}_3 \}$. As it was previously stated, $\mu$MORUS UAV will exploit its shifting center of gravity (CoG) due to the moving masses in order to maneuver and stabilize itself. Therefore, a CoG vector from the origin of the body-fixed frame will be defined as follows:

\begin{equation}
	\vec{r}_{CoG} = \frac{m_{b}\vec{r}_{0,b} + \sum_{i=1}^n m_{i}\vec{r}_{i}}{m_{b} + \sum_{i=1}^4 m_{i}} = \frac{\sum_{i=1}^4 m_{i}\vec{r}_{i}}{m_t},
	\label{equ:cog}
\end{equation}

The following terms are defined as: 
\begin{itemize}
	\item $\vec{r}_{CoG} \in \mathbb{R}^3$ - Center of gravity with respect to the body-fixed frame
	
	\item $\vec{r}_{i} \in \mathbb{R}^3$ - Position of the i-th mass w.r.t. the body-fixed frame
	
	\item $\vec{r}_{b} \in \mathbb{R}^3$ - Position of UAV body w.r.t. the body-fixed frame. Note that because the body frame origin coincides with the rigid body CoG (without considering the moving masses) this term yields $\vec{r}_b = 0_{3x1}$
	
	\item $m_b \in \mathbb{R}$ - Mass of the UAV body 
	
	\item $m_i \in \mathbb{R}$ - Mass of the i-th moving mass attached to the UAV link
	
	\item $m_t \in \mathbb{R}$ - Mass of the whole UAV
\end{itemize}

The equations of motion expressed in the inertial frame while taking in consideration that the CoG is located outside the origin of the body-fixed frame are as follows\cite{LeeModel}: 
\todo[inline]{dodati i prosireni model, ali se vratiti na ovaj}
\begin{gather}
	\dot{x} = v \label{model1}\\
	m_t\dot{v} + m_tge_3 - m_TR \vec{r}_{CoG} \times \dot{\Omega} - m_tR\hat{\Omega}\hat{\vec{r}}_{CoG}\Omega = fRe_3 \label{model2} \\
	\dot{R} = R\hat{\Omega} \label{model3} \\
	J \dot{\Omega} + \Omega \times J \Omega + m_t \vec{r}_{CoG} \times R^T \dot{v} = M \label{model4}
\end{gather}

\noindent The following terms are defined as:

\begin{itemize}
	\item $J \in \mathbb{R}^{3 \times 3}$ - Moment of inertia matrix w.r.t. the body-fixed frame
	
	\item $R \in SO(3)$ - Rotation matrix from the body fixed frame to the inertial frame
	
	\item $\Omega \in \mathbb{R}^3$ - Angular velocity in the body-fixed frame
	
	\item $x \in \mathbb{R}^3$ - Location of the body-fixed frame in the inertial frame
	
	\item $v \in \mathbb{R}^3$ - Velocity of the body-fixed frame in the inertial frame
	
	\item $f \in \mathbb{R}$ - Total thrust produced by the UAV
	
	\item $M \in \mathbb{R}^3$ - Total moments acting in the body-fixed frame
\end{itemize}

\noindent The \textit{hat map} is an operator equivalent to the expression $\hat{x}y = x \times y$. It maps elements of $\mathbb{R}^3$ to the so(3) Lie algebra. \\
Moment of inertia matrix expressed in the body-fixed frame is defined as follows:
\begin{equation}
	J = J_b + \sum_{i=1}^{4}J_i
\end{equation}
where $J_b$ is body and $J_i$ is i-th mass moment of inertia. Using the parallel axis theorem, one is able to calculate $J_i$ while knowing moment of inertia around its CoG:
\begin{equation}
	J_i = J_{i,CoG} + m_i(\vec{r}_i^T \cdot \vec{r}_i I_{3x3} - \vec{r}_i \cdot \vec{r}_i^T)
\end{equation}

\indent Equations \ref{model1}, \ref{model2}, \ref{model3} and \ref{model4} describe the dynamical flow of a rotating and translating rigid body in terms of evolution of $(R,x,\Omega,\dot{x})\in \text{TSE}(3)$ on the tangent bundle of SE(3). \\
\indent Height and yaw of the UAV is controlled by variations in rotor velocity, whereas roll and pitch by moving the masses along UAV links placed in plus configuration. It is assumed that first and third propeller rotate clockwise, while second and fourth rotate counter-clockwise. The relation between moments, thrust and rotor velocity is the following:
\begin{gather}
	f_i = b_f \omega_{i}^2 \label{force}\\
	\tau_i = (-1)^i b_m f_i
\end{gather}

\noindent Where the following terms are defined as:

\begin{itemize}
	\item $f_i \in \mathbb{R}$ - Thrust of the i-th motor
	
	\item $\tau_i \in \mathbb{R}$ - Moment i-th motor produces
	
	\item $b_f \in \mathbb{R}$ - Motor thrust constant
	
	\item $b_m \in \mathbb{R}$ - Motor moment constant
	
	\item $\omega_i \in \mathbb{R}$ - Rotation velocity of the i-th rotor
\end{itemize}

Total thrust can be expressed as:
\begin{equation}
	f = \sum_{1}^{4}f_i
\end{equation}
and total moment acting in the body-fixed frame as:
\begin{equation}
	M = [m_{1}gd_x \cdot b_{3,dx} ,m_{2}gd_y \cdot b_{3,dy},b_m(-f_1 + f_2 - f_3 + f_4)]
\end{equation}
Using f and M as control inputs of the system one is able to obtain the desired force of each rotor and the desired offset of each moving mass $d_x$ and $d_y$. Note that the offset of masses on the same axis is equal. \\
Actuator dynamics of moving masses and the change in desired rotor force will be regarded as instantaneous while presenting the controller synthesis and stability conditions. They will, however, be included within the Gazebo simulation environment.